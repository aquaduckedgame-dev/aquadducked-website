<!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>AquaDucked! - Level Portal</title>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <style>
          * { box-sizing: border-box; }
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
              min-height: 100vh;
              color: #eee;
          }
          h1 { color: #ffd700; text-align: center; }
          h2 { color: #87ceeb; border-bottom: 2px solid #87ceeb; padding-bottom: 10px; }

          /* Upload Form */
          .upload-section {
              background: rgba(255,255,255,0.1);
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 30px;
          }
          input, textarea {
              width: 100%;
              padding: 10px;
              margin: 8px 0;
              border: none;
              border-radius: 5px;
              font-size: 16px;
          }
          textarea { height: 150px; font-family: monospace; }
          button {
              background: #ffd700;
              color: #1a1a2e;
              border: none;
              padding: 12px 24px;
              font-size: 16px;
              font-weight: bold;
              border-radius: 5px;
              cursor: pointer;
              margin-top: 10px;
          }
          button:hover { background: #ffed4a; }

          /* Level List */
          .level-card {
              background: rgba(255,255,255,0.1);
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
          }
          .level-card h3 { margin: 0 0 10px 0; color: #ffd700; }
          .level-card p { margin: 5px 0; color: #ccc; }
          .level-card small { color: #888; }
          .level-actions { margin-top: 10px; }
          .level-actions button {
              margin-right: 10px;
              padding: 8px 16px;
              font-size: 14px;
          }
          .copy-btn { background: #87ceeb; }

          /* Messages */
          .message {
              padding: 10px;
              border-radius: 5px;
              margin: 10px 0;
              text-align: center;
          }
          .success { background: #2e7d32; }
          .error { background: #c62828; }
      </style>
  </head>
  <body>
      <h1>ü¶Ü AquaDucked! Level Portal</h1>

      <!-- Upload Section -->
      <div class="upload-section">
          <h2>Upload a Level</h2>
          <input type="text" id="title" placeholder="Level Title" required>
          <input type="text" id="author" placeholder="Your Name" required>
          <textarea id="description" placeholder="Description (optional)"></textarea>
          <textarea id="levelData" placeholder="Paste your level JSON here..."></textarea>
          <button onclick="uploadLevel()">Upload Level</button>
          <div id="uploadMessage"></div>
      </div>

      <!-- Level List -->
      <div class="levels-section">
          <h2>Browse Levels</h2>
          <div id="levelList">Loading levels...</div>
      </div>

      <script>
          // ‚ö†Ô∏è REPLACE THESE WITH YOUR ACTUAL VALUES FROM SUPABASE
          const SUPABASE_URL = 'https://nobrtuawmmdkympdbdti.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYnJ0dWF3bW1ka3ltcGRiZHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODEzNzMsImV4cCI6MjA3OTk1NzM3M30.ecEYYUtd1X8QCD3pKAYUuj-clrCd7ObX-SQR2vVnRNY';

          // Initialize Supabase
          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          // Load levels on page load
          document.addEventListener('DOMContentLoaded', loadLevels);

          async function loadLevels() {
              const { data, error } = await supabase
                  .from('levels')
                  .select('*')
                  .order('created_at', { ascending: false });

              const levelList = document.getElementById('levelList');

              if (error) {
                  levelList.innerHTML = '<p class="error">Error loading levels: ' + error.message + '</p>';
                  return;
              }

              if (data.length === 0) {
                  levelList.innerHTML = '<p>No levels yet. Be the first to upload!</p>';
                  return;
              }

              levelList.innerHTML = data.map(level => `
                  <div class="level-card">
                      <h3>${escapeHtml(level.title)}</h3>
                      <p>${escapeHtml(level.description || 'No description')}</p>
                      <small>By ${escapeHtml(level.author_name)} ‚Ä¢ ${new Date(level.created_at).toLocaleDateString()} ‚Ä¢
  ${level.download_count} downloads</small>
                      <div class="level-actions">
                          <button onclick="copyLevel(${level.id})">üìã Copy JSON</button>
                          <button class="copy-btn" onclick="copyShareLink(${level.id})">üîó Share Link</button>
                      </div>
                  </div>
              `).join('');
          }

          async function uploadLevel() {
              const title = document.getElementById('title').value.trim();
              const author = document.getElementById('author').value.trim();
              const description = document.getElementById('description').value.trim();
              const levelDataStr = document.getElementById('levelData').value.trim();
              const messageDiv = document.getElementById('uploadMessage');

              // Validation
              if (!title || !author || !levelDataStr) {
                  messageDiv.innerHTML = '<p class="message error">Please fill in title, author, and level data.</p>';
                  return;
              }

              // Parse JSON to validate it
              let levelData;
              try {
                  levelData = JSON.parse(levelDataStr);
              } catch (e) {
                  messageDiv.innerHTML = '<p class="message error">Invalid JSON. Please check your level data.</p>';
                  return;
              }

              // Upload to Supabase
              const { data, error } = await supabase
                  .from('levels')
                  .insert([{
                      title: title,
                      author_name: author,
                      description: description,
                      level_data: levelData
                  }]);

              if (error) {
                  messageDiv.innerHTML = '<p class="message error">Upload failed: ' + error.message + '</p>';
                  return;
              }

              messageDiv.innerHTML = '<p class="message success">Level uploaded successfully!</p>';

              // Clear form and reload levels
              document.getElementById('title').value = '';
              document.getElementById('description').value = '';
              document.getElementById('levelData').value = '';
              loadLevels();
          }

          async function copyLevel(id) {
              const { data, error } = await supabase
                  .from('levels')
                  .select('level_data')
                  .eq('id', id)
                  .single();

              if (error) {
                  alert('Error fetching level: ' + error.message);
                  return;
              }

              // Increment download count
              await supabase
                  .from('levels')
                  .update({ download_count: data.download_count + 1 })
                  .eq('id', id);

              // Copy to clipboard
              navigator.clipboard.writeText(JSON.stringify(data.level_data, null, 2));
              alert('Level JSON copied to clipboard!');
              loadLevels(); // Refresh to show updated count
          }

          function copyShareLink(id) {
              const link = window.location.origin + '?level=' + id;
              navigator.clipboard.writeText(link);
              alert('Share link copied!');
          }

          // Prevent XSS
          function escapeHtml(text) {
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
          }
      </script>
  </body>
  </html>

