<!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>AquaDucked! - Level Portal</title>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <style>
          * { box-sizing: border-box; }
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background: #0d1926;
              min-height: 100vh;
              color: #eee;
          }
          h1 { color: #ffd700; text-align: center; }
          h2 { color: #87ceeb; border-bottom: 2px solid #87ceeb; padding-bottom: 10px; }

          /* Upload Form */
          .upload-section {
              background: rgba(255,255,255,0.1);
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 30px;
          }
          input[type="text"], input[type="password"], textarea, select {
              width: 100%;
              padding: 10px;
              margin: 8px 0;
              border: none;
              border-radius: 5px;
              font-size: 16px;
          }
          select { background: white; }
          textarea { height: 80px; font-family: monospace; }

          /* Tags */
          .tags-section {
              margin: 15px 0;
          }
          .tags-section label {
              display: block;
              margin-bottom: 8px;
              color: #87ceeb;
          }
          .tag-checkboxes {
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
          }
          .tag-checkboxes label {
              background: rgba(255,255,255,0.1);
              padding: 8px 12px;
              border-radius: 20px;
              cursor: pointer;
              transition: background 0.2s;
          }
          .tag-checkboxes input[type="checkbox"] {
              margin-right: 5px;
          }
          .tag-checkboxes label:has(input:checked) {
              background: #87ceeb;
              color: #1a1a2e;
          }

          /* File Input Styling */
          .file-input-wrapper {
              margin: 15px 0;
          }
          .file-input-wrapper > label {
              display: block;
              margin-bottom: 8px;
              color: #87ceeb;
          }
          input[type="file"] {
              width: 100%;
              padding: 10px;
              background: rgba(255,255,255,0.9);
              border-radius: 5px;
              cursor: pointer;
          }
          .file-name {
              margin-top: 8px;
              padding: 10px;
              background: rgba(0,255,0,0.1);
              border-radius: 5px;
              color: #90EE90;
              display: none;
          }
          .file-name.visible { display: block; }
          .file-name.error {
              background: rgba(255,0,0,0.1);
              color: #ff6b6b;
          }

          button {
              background: #ffd700;
              color: #1a1a2e;
              border: none;
              padding: 12px 24px;
              font-size: 16px;
              font-weight: bold;
              border-radius: 5px;
              cursor: pointer;
              margin-top: 10px;
          }
          button:hover { background: #ffed4a; }
          button:disabled { background: #666; cursor: not-allowed; }

          /* Level List */
          .level-card {
              background: rgba(255,255,255,0.1);
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
          }
          .level-card h3 { margin: 0 0 10px 0; color: #ffd700; }
          .level-card .meta { color: #ccc; margin: 5px 0; }
          .level-card small { color: #888; }
          .level-card .difficulty {
              display: inline-block;
              padding: 3px 10px;
              border-radius: 12px;
              font-size: 12px;
              font-weight: bold;
              margin-right: 10px;
          }
          .difficulty-easy { background: #4CAF50; color: white; }
          .difficulty-medium { background: #FF9800; color: white; }
          .difficulty-hard { background: #f44336; color: white; }
          .difficulty-expert { background: #9C27B0; color: white; }

          .level-card .tags {
              margin-top: 8px;
          }
          .level-card .tag {
              display: inline-block;
              background: rgba(135, 206, 235, 0.3);
              color: #87ceeb;
              padding: 3px 10px;
              border-radius: 12px;
              font-size: 12px;
              margin-right: 5px;
              margin-top: 5px;
          }

          .level-actions { margin-top: 10px; }
          .level-actions button {
              margin-right: 10px;
              padding: 8px 16px;
              font-size: 14px;
          }
          .download-btn { background: #4CAF50; color: white; }
          .download-btn:hover { background: #45a049; }
          .share-btn { background: #87ceeb; }

          /* Messages */
          .message {
              padding: 10px;
              border-radius: 5px;
              margin: 10px 0;
              text-align: center;
          }
          .success { background: #2e7d32; }
          .error { background: #c62828; }

          /* Upload code field */
          .code-field {
              background: rgba(255,215,0,0.1);
              border: 2px solid #ffd700;
          }
      </style>
  </head>
  <body>
      <div style="text-align: center; margin-bottom: 20px;">
          <img src="logo.png" alt="AquaDucked!" style="max-width: 400px; width: 100%;">
          <h2 style="color: #87ceeb; margin-top: 10px;">Level Portal</h2>
      </div>

      <!-- Upload Section -->
      <div class="upload-section">
          <h2>Upload a Level</h2>
          <input type="password" id="uploadCode" class="code-field" placeholder="Upload Code (required)" required>
          <input type="text" id="title" placeholder="Level Title" required>
          <input type="text" id="author" placeholder="Your Name" required>

          <select id="difficulty">
              <option value="">-- Select Difficulty --</option>
              <option value="easy">Easy</option>
              <option value="medium">Medium</option>
              <option value="hard">Hard</option>
              <option value="expert">Expert</option>
          </select>

          <div class="tags-section">
              <label>Tags (select all that apply)</label>
              <div class="tag-checkboxes">
                  <label><input type="checkbox" value="Puzzle"> Puzzle</label>
                  <label><input type="checkbox" value="Action"> Action</label>
                  <label><input type="checkbox" value="Precision"> Precision</label>
                  <label><input type="checkbox" value="Creative"> Creative</label>
                  <label><input type="checkbox" value="Short"> Short</label>
                  <label><input type="checkbox" value="Long"> Long</label>
                  <label><input type="checkbox" value="Water"> Water</label>
                  <label><input type="checkbox" value="Tricky"> Tricky</label>
              </div>
          </div>

          <div class="file-input-wrapper">
              <label>Select Level File (.json)</label>
              <input type="file" id="levelFile" accept=".json" onchange="handleFileSelect(event)">
              <div id="fileName" class="file-name"></div>
          </div>

          <button onclick="uploadLevel()" id="uploadBtn">Upload Level</button>
          <div id="uploadMessage"></div>
      </div>

      <!-- Level List -->
      <div class="levels-section">
          <h2>Browse Levels</h2>
          <div id="levelList">Loading levels...</div>
      </div>

      <script>
          // âš ï¸ REPLACE THESE WITH YOUR ACTUAL VALUES FROM SUPABASE
          const SUPABASE_URL = 'https://nobrtuawmmdkympdbdti.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYnJ0dWF3bW1ka3ltcGRiZHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODEzNzMsImV4cCI6MjA3OTk1NzM3M30.ecEYYUtd1X8QCD3pKAYUuj-clrCd7ObX-SQR2vVnRNY';

          // âš ï¸ CHANGE THIS TO YOUR SECRET UPLOAD CODE
          const UPLOAD_CODE = 'ducktals';

          // Initialize Supabase
          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          // Store selected file data
          let selectedLevelData = null;
          let fileValidationPassed = false;

          // Load levels on page load
          document.addEventListener('DOMContentLoaded', loadLevels);

          function validateLevelData(data) {
              const errors = [];

              if (!data.duck_start_position && !data.duck_start) {
                  errors.push('Missing duck_start position');
              } else {
                  if (typeof data.duck_start.x !== 'number') errors.push('duck_start.x must be a number');
                  if (typeof data.duck_start.y !== 'number') errors.push('duck_start.y must be a number');
              }

              if (!data.goal_position && !data.goal) {
                  errors.push('Missing goal position');
              } else {
                  if (typeof data.goal.x !== 'number') errors.push('goal.x must be a number');
                  if (typeof data.goal.y !== 'number') errors.push('goal.y must be a number');
              }

              return errors;
          }

          function getSelectedTags() {
              const checkboxes = document.querySelectorAll('.tag-checkboxes input[type="checkbox"]:checked');
              return Array.from(checkboxes).map(cb => cb.value);
          }

          function handleFileSelect(event) {
              const file = event.target.files[0];
              const fileNameDiv = document.getElementById('fileName');

              if (!file) {
                  selectedLevelData = null;
                  fileValidationPassed = false;
                  fileNameDiv.classList.remove('visible');
                  return;
              }

              const reader = new FileReader();
              reader.onload = function(e) {
                  try {
                      const data = JSON.parse(e.target.result);

                      const validationErrors = validateLevelData(data);

                      if (validationErrors.length > 0) {
                          selectedLevelData = null;
                          fileValidationPassed = false;
                          fileNameDiv.innerHTML = 'âœ— Invalid level file:<br>â€¢ ' + validationErrors.join('<br>â€¢ ');
                          fileNameDiv.classList.add('visible', 'error');
                          return;
                      }

                      selectedLevelData = data;
                      fileValidationPassed = true;
                      fileNameDiv.textContent = 'âœ“ Valid level: ' + file.name;
                      fileNameDiv.classList.add('visible');
                      fileNameDiv.classList.remove('error');

                      const titleInput = document.getElementById('title');
                      if (!titleInput.value) {
                          titleInput.value = data.level_id || file.name.replace('.json', '');
                      }

                      const authorInput = document.getElementById('author');
                      if (!authorInput.value && data.author) {
                          authorInput.value = data.author;
                      }

                  } catch (err) {
                      selectedLevelData = null;
                      fileValidationPassed = false;
                      fileNameDiv.textContent = 'âœ— Invalid JSON file: ' + err.message;
                      fileNameDiv.classList.add('visible', 'error');
                  }
              };
              reader.readAsText(file);
          }

          async function loadLevels() {
              const { data, error } = await supabase
                  .from('levels')
                  .select('*')
                  .order('created_at', { ascending: false });

              const levelList = document.getElementById('levelList');

              if (error) {
                  levelList.innerHTML = '<p class="message error">Error loading levels: ' + error.message + '</p>';
                  return;
              }

              if (data.length === 0) {
                  levelList.innerHTML = '<p>No levels yet. Be the first to upload!</p>';
                  return;
              }

              levelList.innerHTML = data.map(level => {
                  const difficultyClass = level.difficulty ? `difficulty-${level.difficulty}` : '';
                  const difficultyLabel = level.difficulty ? level.difficulty.charAt(0).toUpperCase() +
  level.difficulty.slice(1) : '';
                  const tags = level.tags ? level.tags.split(',').filter(t => t.trim()) : [];

                  return `
                      <div class="level-card">
                          <h3>${escapeHtml(level.title)}</h3>
                          <div class="meta">
                              By ${escapeHtml(level.author_name)}
                              ${difficultyLabel ? `<span class="difficulty ${difficultyClass}">${difficultyLabel}</span>` :     
  ''}
                          </div>
                          ${tags.length > 0 ? `
                              <div class="tags">
                                  ${tags.map(tag => `<span class="tag">${escapeHtml(tag.trim())}</span>`).join('')}
                              </div>
                          ` : ''}
                          <small>${new Date(level.created_at).toLocaleDateString()} â€¢ ${level.download_count}
  downloads</small>
                          <div class="level-actions">
                              <button class="download-btn" onclick="downloadLevel(${level.id},
  '${escapeJs(level.title)}')">â¬‡ Download</button>
                              <button class="share-btn" onclick="copyShareLink(${level.id})">ðŸ”— Share</button>
                          </div>
                      </div>
                  `;
              }).join('');
          }

          async function uploadLevel() {
              const messageDiv = document.getElementById('uploadMessage');
              const uploadCode = document.getElementById('uploadCode').value.trim();

              if (uploadCode !== UPLOAD_CODE) {
                  messageDiv.innerHTML = '<p class="message error">Invalid upload code.</p>';
                  return;
              }

              const title = document.getElementById('title').value.trim();
              const author = document.getElementById('author').value.trim();
              const difficulty = document.getElementById('difficulty').value;
              const tags = getSelectedTags().join(',');

              if (!title || !author) {
                  messageDiv.innerHTML = '<p class="message error">Please fill in title and author.</p>';
                  return;
              }

              if (!selectedLevelData || !fileValidationPassed) {
                  messageDiv.innerHTML = '<p class="message error">Please select a valid level JSON file.</p>';
                  return;
              }

              const { data, error } = await supabase
                  .from('levels')
                  .insert([{
                      title: title,
                      author_name: author,
                      difficulty: difficulty,
                      tags: tags,
                      level_data: selectedLevelData
                  }]);

              if (error) {
                  messageDiv.innerHTML = '<p class="message error">Upload failed: ' + error.message + '</p>';
                  return;
              }

              messageDiv.innerHTML = '<p class="message success">Level uploaded successfully!</p>';

              // Clear form
              document.getElementById('title').value = '';
              document.getElementById('difficulty').value = '';
              document.querySelectorAll('.tag-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
              document.getElementById('levelFile').value = '';
              document.getElementById('fileName').classList.remove('visible');
              selectedLevelData = null;
              fileValidationPassed = false;
              loadLevels();
          }

          async function downloadLevel(id, title) {
              const { data, error } = await supabase
                  .from('levels')
                  .select('level_data, download_count')
                  .eq('id', id)
                  .single();

              if (error) {
                  alert('Error fetching level: ' + error.message);
                  return;
              }

              await supabase
                  .from('levels')
                  .update({ download_count: data.download_count + 1 })
                  .eq('id', id);

              const blob = new Blob([JSON.stringify(data.level_data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = title.replace(/[^a-z0-9]/gi, '_') + '.json';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              loadLevels();
          }

          function copyShareLink(id) {
              const link = window.location.origin + '?level=' + id;
              navigator.clipboard.writeText(link);
              alert('Share link copied!');
          }

          function escapeHtml(text) {
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
          }

          function escapeJs(text) {
              return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
          }
      </script>
  </body>
  </html>
