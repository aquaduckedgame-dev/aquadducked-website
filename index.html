<!DOCTYPE html>
  <html lang="en">
  <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>AquaDucked! - Level Portal</title>
      <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
      <style>
          * { box-sizing: border-box; }
          body {
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
              max-width: 800px;
              margin: 0 auto;
              padding: 20px;
              background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
              min-height: 100vh;
              color: #eee;
          }
          h1 { color: #ffd700; text-align: center; }
          h2 { color: #87ceeb; border-bottom: 2px solid #87ceeb; padding-bottom: 10px; }

          /* Upload Form */
          .upload-section {
              background: rgba(255,255,255,0.1);
              padding: 20px;
              border-radius: 10px;
              margin-bottom: 30px;
          }
          input[type="text"], input[type="password"], textarea {
              width: 100%;
              padding: 10px;
              margin: 8px 0;
              border: none;
              border-radius: 5px;
              font-size: 16px;
          }
          textarea { height: 100px; font-family: monospace; }

          /* File Input Styling */
          .file-input-wrapper {
              margin: 15px 0;
          }
          .file-input-wrapper label {
              display: block;
              margin-bottom: 8px;
              color: #87ceeb;
          }
          input[type="file"] {
              width: 100%;
              padding: 10px;
              background: rgba(255,255,255,0.9);
              border-radius: 5px;
              cursor: pointer;
          }
          .file-name {
              margin-top: 8px;
              padding: 10px;
              background: rgba(0,255,0,0.1);
              border-radius: 5px;
              color: #90EE90;
              display: none;
          }
          .file-name.visible { display: block; }
          .file-name.error {
              background: rgba(255,0,0,0.1);
              color: #ff6b6b;
          }

          button {
              background: #ffd700;
              color: #1a1a2e;
              border: none;
              padding: 12px 24px;
              font-size: 16px;
              font-weight: bold;
              border-radius: 5px;
              cursor: pointer;
              margin-top: 10px;
          }
          button:hover { background: #ffed4a; }
          button:disabled { background: #666; cursor: not-allowed; }

          /* Level List */
          .level-card {
              background: rgba(255,255,255,0.1);
              padding: 15px;
              border-radius: 10px;
              margin-bottom: 15px;
          }
          .level-card h3 { margin: 0 0 10px 0; color: #ffd700; }
          .level-card p { margin: 5px 0; color: #ccc; }
          .level-card small { color: #888; }
          .level-actions { margin-top: 10px; }
          .level-actions button {
              margin-right: 10px;
              padding: 8px 16px;
              font-size: 14px;
          }
          .download-btn { background: #4CAF50; color: white; }
          .download-btn:hover { background: #45a049; }
          .share-btn { background: #87ceeb; }

          /* Messages */
          .message {
              padding: 10px;
              border-radius: 5px;
              margin: 10px 0;
              text-align: center;
          }
          .success { background: #2e7d32; }
          .error { background: #c62828; }

          /* Upload code field */
          .code-field {
              background: rgba(255,215,0,0.1);
              border: 2px solid #ffd700;
          }
      </style>
  </head>
  <body>
      <h1>ðŸ¦† AquaDucked! Level Portal</h1>

      <!-- Upload Section -->
      <div class="upload-section">
          <h2>Upload a Level</h2>
          <input type="password" id="uploadCode" class="code-field" placeholder="Upload Code (required)" required>
          <input type="text" id="title" placeholder="Level Title" required>
          <input type="text" id="author" placeholder="Your Name" required>
          <textarea id="description" placeholder="Description (optional)"></textarea>

          <div class="file-input-wrapper">
              <label>Select Level File (.json)</label>
              <input type="file" id="levelFile" accept=".json" onchange="handleFileSelect(event)">
              <div id="fileName" class="file-name"></div>
          </div>

          <button onclick="uploadLevel()" id="uploadBtn">Upload Level</button>
          <div id="uploadMessage"></div>
      </div>

      <!-- Level List -->
      <div class="levels-section">
          <h2>Browse Levels</h2>
          <div id="levelList">Loading levels...</div>
      </div>

      <script>
          // âš ï¸ REPLACE THESE WITH YOUR ACTUAL VALUES FROM SUPABASE
          const SUPABASE_URL = 'https://nobrtuawmmdkympdbdti.supabase.co';
          const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5vYnJ0dWF3bW1ka3ltcGRiZHRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzODEzNzMsImV4cCI6MjA3OTk1NzM3M30.ecEYYUtd1X8QCD3pKAYUuj-clrCd7ObX-SQR2vVnRNY';

          // âš ï¸ CHANGE THIS TO YOUR SECRET UPLOAD CODE
          const UPLOAD_CODE = 'ducktals';

          // Initialize Supabase
          const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

          // Store selected file data
          let selectedLevelData = null;
          let fileValidationPassed = false;

          // Load levels on page load
          document.addEventListener('DOMContentLoaded', loadLevels);

          function validateLevelData(data) {
              const errors = [];

              // Check for required fields
              if (!data.duck_start) {
                  errors.push('Missing duck_start position');
              } else {
                  if (typeof data.duck_start.x !== 'number') errors.push('duck_start.x must be a number');
                  if (typeof data.duck_start.y !== 'number') errors.push('duck_start.y must be a number');
              }

              if (!data.goal) {
                  errors.push('Missing goal position');
              } else {
                  if (typeof data.goal.x !== 'number') errors.push('goal.x must be a number');
                  if (typeof data.goal.y !== 'number') errors.push('goal.y must be a number');
              }

              return errors;
          }

          function handleFileSelect(event) {
              const file = event.target.files[0];
              const fileNameDiv = document.getElementById('fileName');

              if (!file) {
                  selectedLevelData = null;
                  fileValidationPassed = false;
                  fileNameDiv.classList.remove('visible');
                  return;
              }

              const reader = new FileReader();
              reader.onload = function(e) {
                  try {
                      const data = JSON.parse(e.target.result);

                      // Validate level structure
                      const validationErrors = validateLevelData(data);

                      if (validationErrors.length > 0) {
                          selectedLevelData = null;
                          fileValidationPassed = false;
                          fileNameDiv.innerHTML = 'âœ— Invalid level file:<br>â€¢ ' + validationErrors.join('<br>â€¢ ');
                          fileNameDiv.classList.add('visible', 'error');
                          return;
                      }

                      // Valid level!
                      selectedLevelData = data;
                      fileValidationPassed = true;
                      fileNameDiv.textContent = 'âœ“ Valid level: ' + file.name;
                      fileNameDiv.classList.add('visible');
                      fileNameDiv.classList.remove('error');

                      // Auto-fill title from level_id or filename if empty
                      const titleInput = document.getElementById('title');
                      if (!titleInput.value) {
                          titleInput.value = data.level_id || file.name.replace('.json', '');
                      }

                      // Auto-fill author from level data if available
                      const authorInput = document.getElementById('author');
                      if (!authorInput.value && data.author) {
                          authorInput.value = data.author;
                      }

                  } catch (err) {
                      selectedLevelData = null;
                      fileValidationPassed = false;
                      fileNameDiv.textContent = 'âœ— Invalid JSON file: ' + err.message;
                      fileNameDiv.classList.add('visible', 'error');
                  }
              };
              reader.readAsText(file);
          }

          async function loadLevels() {
              const { data, error } = await supabase
                  .from('levels')
                  .select('*')
                  .order('created_at', { ascending: false });

              const levelList = document.getElementById('levelList');

              if (error) {
                  levelList.innerHTML = '<p class="message error">Error loading levels: ' + error.message + '</p>';
                  return;
              }

              if (data.length === 0) {
                  levelList.innerHTML = '<p>No levels yet. Be the first to upload!</p>';
                  return;
              }

              levelList.innerHTML = data.map(level => `
                  <div class="level-card">
                      <h3>${escapeHtml(level.title)}</h3>
                      <p>${escapeHtml(level.description || 'No description')}</p>
                      <small>By ${escapeHtml(level.author_name)} â€¢ ${new Date(level.created_at).toLocaleDateString()} â€¢
  ${level.download_count} downloads</small>
                      <div class="level-actions">
                          <button class="download-btn" onclick="downloadLevel(${level.id}, '${escapeJs(level.title)}')">â¬‡       
  Download JSON</button>
                          <button class="share-btn" onclick="copyShareLink(${level.id})">ðŸ”— Share Link</button>
                      </div>
                  </div>
              `).join('');
          }

          async function uploadLevel() {
              const messageDiv = document.getElementById('uploadMessage');
              const uploadCode = document.getElementById('uploadCode').value.trim();

              // Check upload code
              if (uploadCode !== UPLOAD_CODE) {
                  messageDiv.innerHTML = '<p class="message error">Invalid upload code.</p>';
                  return;
              }

              const title = document.getElementById('title').value.trim();
              const author = document.getElementById('author').value.trim();
              const description = document.getElementById('description').value.trim();

              // Validation
              if (!title || !author) {
                  messageDiv.innerHTML = '<p class="message error">Please fill in title and author.</p>';
                  return;
              }

              if (!selectedLevelData || !fileValidationPassed) {
                  messageDiv.innerHTML = '<p class="message error">Please select a valid level JSON file.</p>';
                  return;
              }

              // Upload to Supabase
              const { data, error } = await supabase
                  .from('levels')
                  .insert([{
                      title: title,
                      author_name: author,
                      description: description,
                      level_data: selectedLevelData
                  }]);

              if (error) {
                  messageDiv.innerHTML = '<p class="message error">Upload failed: ' + error.message + '</p>';
                  return;
              }

              messageDiv.innerHTML = '<p class="message success">Level uploaded successfully!</p>';

              // Clear form and reload levels
              document.getElementById('title').value = '';
              document.getElementById('description').value = '';
              document.getElementById('levelFile').value = '';
              document.getElementById('fileName').classList.remove('visible');
              selectedLevelData = null;
              fileValidationPassed = false;
              loadLevels();
          }

          async function downloadLevel(id, title) {
              const { data, error } = await supabase
                  .from('levels')
                  .select('level_data, download_count')
                  .eq('id', id)
                  .single();

              if (error) {
                  alert('Error fetching level: ' + error.message);
                  return;
              }

              // Increment download count
              await supabase
                  .from('levels')
                  .update({ download_count: data.download_count + 1 })
                  .eq('id', id);

              // Create and download file
              const blob = new Blob([JSON.stringify(data.level_data, null, 2)], { type: 'application/json' });
              const url = URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = url;
              a.download = title.replace(/[^a-z0-9]/gi, '_') + '.json';
              document.body.appendChild(a);
              a.click();
              document.body.removeChild(a);
              URL.revokeObjectURL(url);

              loadLevels(); // Refresh to show updated count
          }

          function copyShareLink(id) {
              const link = window.location.origin + '?level=' + id;
              navigator.clipboard.writeText(link);
              alert('Share link copied!');
          }

          // Prevent XSS
          function escapeHtml(text) {
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
          }

          // Escape for JS strings in onclick
          function escapeJs(text) {
              return text.replace(/'/g, "\\'").replace(/"/g, '\\"');
          }
      </script>
  </body>
  </html>
